<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pricing Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .form-section {
            padding: 40px;
            background: #f8f9fa;
        }

        .results-section {
            padding: 40px;
            background: white;
            border-left: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #28a745;
            margin-top: 10px;
        }

        .btn-feedback {
            background: #17a2b8;
            padding: 10px 20px;
            font-size: 0.95rem;
            margin-top: 15px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .price-result {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border-left: 5px solid #4caf50;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .price-amount {
            font-size: 2rem;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .margin-display {
            font-size: 1.2rem;
            color: #1b5e20;
            font-weight: 600;
        }

        .reasoning {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .reasoning h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .recommendations {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .recommendations h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }

        .feedback-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .feedback-section h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .feedback-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .conversation-history {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .conversation-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .user-message {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .assistant-message {
            background: #f1f8e9;
            border-left: 3px solid #8bc34a;
        }

        .data-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #c62828;
        }

        .competitor-preview {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .competitor-row {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .results-section {
                border-left: none;
                border-top: 1px solid #e9ecef;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¤– AI Pricing Calculator</h1>
            <p>Intelligent competitive pricing with real-time market analysis</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title">Customer Details</h2>
                
                <form id="pricingForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="location">Location/County:</label>
                            <input type="text" id="location" required placeholder="e.g., Pitkin, Weld County">
                        </div>
                        <div class="form-group">
                            <label for="volume">Volume Needed:</label>
                            <input type="text" id="volume" required placeholder="e.g., 500 gallons">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="product">Product Type:</label>
                            <select id="product" required>
                                <option value="">Select product...</option>
                                <option value="Accu-Tab Tablets">Accu-Tab Tablets</option>
                                <option value="Accu-Tab Tablets Blue">Accu-Tab Tablets Blue</option>
                                <option value="Acid Blue">Acid Blue (Acid Magic-replacement)</option>
                                <option value="Acid Magic">Acid Magic</option>
                                <option value="Activated Carbon">Activated Carbon</option>
                                <option value="Aluminum Chloride">Aluminum Chloride</option>
                                <option value="Aluminum Chlorhydrate">Aluminum Chlorhydrate</option>
                                <option value="Aluminum Chlorohydrate">Aluminum Chlorohydrate 50% (CC-2000)</option>
                                <option value="Aluminum Chloride Hydroxide Sulfate">Aluminum Chloride Hydroxide Sulfate</option>
                                <option value="Aluminum Sulfate Ground">Aluminum Sulfate Ground (Granular)</option>
                                <option value="Aluminum Sulfate Liquid">Aluminum Sulfate Liquid</option>
                                <option value="Aluminum Sulfate Powder">Aluminum Sulfate Powder</option>
                                <option value="Ammonium Hydroxide">Ammonium Hydroxide</option>
                                <option value="Ammonium Sulfate Granular">Ammonium Sulfate (Granular)</option>
                                <option value="Ammonium Sulfate Liquid">Ammonium Sulfate Liquid (LAS) NSF</option>
                                <option value="AQ 101">AQ 101</option>
                                <option value="AQ 109">AQ 109</option>
                                <option value="Aqua Mag DR446">Aqua Mag DR446</option>
                                <option value="Bio-Max">Bio-Max</option>
                                <option value="Bioxide">Bioxide</option>
                                <option value="Blended Phosphate">Blended Phosphate</option>
                                <option value="Bromine">Bromine</option>
                                <option value="Cairox FF">Cairox FF</option>
                                <option value="Calcium">Calcium</option>
                                <option value="Calcium Chloride Flake">Calcium Chloride Flake</option>
                                <option value="Calcium Hypochlorite">Calcium Hypochlorite</option>
                                <option value="Calcium Hypochlorite 3in tabs">Calcium Hypochlorite 3" tabs</option>
                                <option value="Calcium Hypochlorite Granular">Calcium Hypochlorite Granular (Cal-Shock)</option>
                                <option value="Carbon Dioxide">Carbon Dioxide</option>
                                <option value="Carus 3180">Carus 3180</option>
                                <option value="Carus 8600">Carus 8600</option>
                                <option value="Cat-Floc 8102">Cat-Floc 8102</option>
                                <option value="Cat-Floc 8103">Cat-Floc 8103</option>
                                <option value="Cat-Floc 8108">Cat-Floc 8108</option>
                                <option value="Caustic Soda">Caustic Soda</option>
                                <option value="Caustic Soda 20%">Caustic Soda 20%</option>
                                <option value="Caustic Soda 25%">Caustic Soda 25%</option>
                                <option value="Caustic Soda 30%">Caustic Soda 30%</option>
                                <option value="Caustic Soda 50%">Caustic Soda 50% (Sodium Hydroxide)</option>
                                <option value="Caustic Soda Pearl">Caustic Soda - pearl</option>
                                <option value="Caustic Soda Micropearls">Caustic Soda - Micropearls NSF</option>
                                <option value="CC 2000">CC 2000</option>
                                <option value="CC 2210">CC 2210</option>
                                <option value="CC 2215">CC 2215</option>
                                <option value="CC 2220">CC 2220</option>
                                <option value="CC 2250">CC 2250</option>
                                <option value="CED Struvite Remover">CED Struvite Remover</option>
                                <option value="Chlorine">Chlorine</option>
                                <option value="Chlorine Dioxide">Chlorine Dioxide</option>
                                <option value="Chlorine Gas">Chlorine Gas</option>
                                <option value="Citric Acid">Citric Acid 50%</option>
                                <option value="Clarifloc A-210P">Clarifloc A-210P</option>
                                <option value="Clarifloc C-1400">Clarifloc C-1400</option>
                                <option value="Clarifloc C-2717">Clarifloc C-2717</option>
                                <option value="Clarifloc C-3275">Clarifloc C-3275</option>
                                <option value="Clarifloc C-3287">Clarifloc C-3287</option>
                                <option value="Clarifloc C-3294">Clarifloc C-3294</option>
                                <option value="Clarifloc C-308P">Clarifloc C-308P</option>
                                <option value="Clarifloc C-6253">Clarifloc C-6253</option>
                                <option value="Clarifloc C-6257">Clarifloc C-6257</option>
                                <option value="Clarifloc C-6262">Clarifloc C-6262</option>
                                <option value="Clarifloc C-6266">Clarifloc C-6266</option>
                                <option value="Clarifloc C-6266A">Clarifloc C-6266A</option>
                                <option value="Clarifloc C-6276">Clarifloc C-6276</option>
                                <option value="Clarifloc C-6285">Clarifloc C-6285</option>
                                <option value="Clarifloc C-6286">Clarifloc C-6286</option>
                                <option value="Clarifloc C-6292">Clarifloc C-6292</option>
                                <option value="Clarifloc C-6295">Clarifloc C-6295</option>
                                <option value="Clarifloc C-9530">Clarifloc C-9530</option>
                                <option value="Clarifloc C-9545">Clarifloc C-9545</option>
                                <option value="Clarifloc CE-1042">Clarifloc CE-1042</option>
                                <option value="Clarifloc CE-1404">Clarifloc CE-1404</option>
                                <option value="Clarifloc CE-2693">Clarifloc CE-2693</option>
                                <option value="Clarifloc CE-464">Clarifloc CE-464</option>
                                <option value="Clarifloc CE-692">Clarifloc CE-692</option>
                                <option value="Clarifloc PRXB26">Clarifloc PRXB26</option>
                                <option value="Clar+Ion A5">Clar+Ion A5</option>
                                <option value="Core Shell 71300">Core Shell 71300</option>
                                <option value="Core Shell 71301">Core Shell 71301</option>
                                <option value="Core Shell 71306">Core Shell 71306</option>
                                <option value="Core Shell 71307">Core Shell 71307</option>
                                <option value="Core Shell 71325">Core Shell 71325</option>
                                <option value="Copper Sulfate">Copper Sulfate</option>
                                <option value="Cyanuric Acid">Cyanuric Acid/Stabilizer</option>
                                <option value="D-Chlor">D-Chlor</option>
                                <option value="Dechlorination Tablets">Dechlorination Tablets</option>
                                <option value="Dowflake">Dowflake - Calcium Chloride 83-87%</option>
                                <option value="Ferric Chloride">Ferric Chloride 38%</option>
                                <option value="Ferric Sulfate">Ferric Sulfate 60%</option>
                                <option value="FilterX 7200">FilterX 7200</option>
                                <option value="Formula 52">Formula 52</option>
                                <option value="Glycerin">Glycerin</option>
                                <option value="Hydrated Lime">Hydrated Lime - Calcium Hydroxide</option>
                                <option value="Hydrochloric Acid">Hydrochloric Acid 31%/Muriatic Acid</option>
                                <option value="Hydrochloric Acid 35%">Hydrochloric Acid 35%</option>
                                <option value="Hydrofluorosilicic Acid">Hydrofluorosilicic Acid 20%-25%</option>
                                <option value="Hydrofluosilicic Acid 23%">Hydrofluosilicic Acid 23%</option>
                                <option value="Hydrofloc 1665">Hydrofloc 1665</option>
                                <option value="Hydrofloc 1687">Hydrofloc 1687</option>
                                <option value="HydroFloc 750c">HydroFloc 750c</option>
                                <option value="Hydrogen Peroxide 20%">Hydrogen Peroxide 20%</option>
                                <option value="Hydrogen Peroxide 30%">Hydrogen Peroxide 30%</option>
                                <option value="Hydrogen Peroxide 34%">Hydrogen Peroxide 34%</option>
                                <option value="Hyper+ Ion 1090">Hyper+ Ion 1090</option>
                                <option value="Hyper+ Ion 4654">Hyper+ Ion 4654</option>
                                <option value="HyperIon 9084">HyperIon 9084</option>
                                <option value="Kemira Pax 18">Kemira Pax 18</option>
                                <option value="Kemira Pax 312">Kemira Pax 312</option>
                                <option value="Kemira Pax L8">Kemira Pax L8</option>
                                <option value="Kemira Pax XL6">Kemira Pax XL6</option>
                                <option value="Kemira Pax XLB">Kemira Pax XLB</option>
                                <option value="Liquid Ammonium">Liquid Ammonium</option>
                                <option value="Liquid Carbon Dioxide">Liquid Carbon Dioxide</option>
                                <option value="Liquid Oxygen">Liquid Oxygen</option>
                                <option value="Magafloc LT7995">Magafloc LT7995</option>
                                <option value="Magnafloc LT20">Magnafloc LT20</option>
                                <option value="Magnesium Hydroxide">Magnesium Hydroxide 58-61%</option>
                                <option value="Metalsorb PCZ">Metalsorb PCZ</option>
                                <option value="Methanol">Methanol</option>
                                <option value="MicroC 2000">MicroC 2000</option>
                                <option value="Multi-Function Chlorinator">Multi-Function Chlorinator - Dichlor</option>
                                <option value="Muriatic Acid">Muriatic Acid 9%/15%/22Â°/31%</option>
                                <option value="Nalclear 7763">Nalclear 7763</option>
                                <option value="Nalclear 7766">Nalclear 7766</option>
                                <option value="Nalclear 8100">Nalclear 8100</option>
                                <option value="Nalclear 8170">Nalclear 8170</option>
                                <option value="Nalclear 8173">Nalclear 8173</option>
                                <option value="Nalclear 8181">Nalclear 8181</option>
                                <option value="Nalco 7390">Nalco 7390</option>
                                <option value="Nalco 8102">Nalco 8102</option>
                                <option value="Nalco 9907">Nalco 9907</option>
                                <option value="Nalcolyte 8100">Nalcolyte 8100</option>
                                <option value="Nalmet 1691">Nalmet 1691</option>
                                <option value="Optimer 7128">Optimer 7128</option>
                                <option value="Optimer 7139">Optimer 7139</option>
                                <option value="Optimer 7194">Optimer 7194</option>
                                <option value="Optimer 8110">Optimer 8110</option>
                                <option value="Orthophosphate">Orthophosphate</option>
                                <option value="Permaclean PC-77">Permaclean PC-77</option>
                                <option value="Permatreat PC-391T">Permatreat PC-391T</option>
                                <option value="Phosphoric Acid 75%">Phosphoric Acid 75%</option>
                                <option value="POL-E-ZOLV PL365">POL-E-ZOLV PL365</option>
                                <option value="Poly Aluminum Chloride">Poly Aluminum Chloride (AS-3030)</option>
                                <option value="Poly Orthophosphate PT-170">Poly Orthophosphate (PT-170)</option>
                                <option value="Poly Orthophosphate WSU-137">Poly Orthophosphate (WSU-137)</option>
                                <option value="PolyFerric Sulfate">PolyFerric Sulfate</option>
                                <option value="Polymer">Polymer (various types)</option>
                                <option value="Polymer C591">Polymer C591</option>
                                <option value="Polymer K110">Polymer K110</option>
                                <option value="Polymer WT-830A">Polymer (WT-830A)</option>
                                <option value="Polyphosphate">Polyphosphate</option>
                                <option value="Potassium Chloride">Potassium Chloride (K-Life)</option>
                                <option value="Potassium Permanganate">Potassium Permanganate - Powder</option>
                                <option value="Praestol DW20">Praestol DW20</option>
                                <option value="Praestol DW22">Praestol DW22</option>
                                <option value="Praestol DW22S">Praestol DW22S</option>
                                <option value="Praestol DWS22S">Praestol DWS22S</option>
                                <option value="Praestol K260">Praestol K260</option>
                                <option value="Praestol K274">Praestol K274</option>
                                <option value="Praestol K275">Praestol K275</option>
                                <option value="Praestol K279">Praestol K279</option>
                                <option value="Pretreat Liquid Antiscalant">Pretreat Liquid Antiscalant</option>
                                <option value="Pretreat Plus 100">Pretreat Plus 100</option>
                                <option value="Pretreat Plus Antiscalant">Pretreat Plus Antiscalant</option>
                                <option value="Pretreat Plus Select">Pretreat Plus Select</option>
                                <option value="Puri-Cal">Puri-Cal</option>
                                <option value="RootX">RootX</option>
                                <option value="Salt">Salt - Water Softening (SureSoft XCS)</option>
                                <option value="Seaquest Dry">Seaquest Dry</option>
                                <option value="Seaquest Liquid">Seaquest Liquid</option>
                                <option value="Soda Ash Dense">Soda Ash Dense (Sodium Carbonate)</option>
                                <option value="Soda Ash Light">Soda Ash Light (Sodium Carbonate)</option>
                                <option value="Sodium Aluminate">Sodium Aluminate 33%/38%</option>
                                <option value="Sodium Bicarbonate">Sodium Bicarbonate</option>
                                <option value="Sodium Bisulfate">Sodium Bisulfate</option>
                                <option value="Sodium Bisulfite">Sodium Bisulfite 38-43%</option>
                                <option value="Sodium Chlorite">Sodium Chlorite</option>
                                <option value="Sodium Fluoride">Sodium Fluoride</option>
                                <option value="Sodium Fluorosilicate">Sodium Fluorosilicate</option>
                                <option value="Sodium Hydroxide">Sodium Hydroxide (See Caustic Soda)</option>
                                <option value="Sodium Hypochlorite 5.5%">Sodium Hypochlorite 5.5%</option>
                                <option value="Sodium Hypochlorite 10%">Sodium Hypochlorite 10%</option>
                                <option value="Sodium Hypochlorite 12.5%">Sodium Hypochlorite 12.5%</option>
                                <option value="Sodium Metabisulfite">Sodium Metabisulfite</option>
                                <option value="Sodium Metasilicate">Sodium Metasilicate</option>
                                <option value="Sodium Permanganate">Sodium Permanganate 40%</option>
                                <option value="Sodium Phosphate">Sodium Phosphate</option>
                                <option value="Sodium Silicate">Sodium Silicate N CLEAR NSF</option>
                                <option value="Sodium Silicofluoride">Sodium Silicofluoride</option>
                                <option value="Sodium Sulfate">Sodium Sulfate</option>
                                <option value="Sodium Thiosulfate">Sodium Thiosulfate</option>
                                <option value="Solve 218B">Solve 218B</option>
                                <option value="SpectraGuard">SpectraGuard</option>
                                <option value="Sulfate of Potash">Sulfate of Potash</option>
                                <option value="Sulfur Dioxide">Sulfur Dioxide</option>
                                <option value="Sulfuric Acid 35%">Sulfuric Acid 35-36%</option>
                                <option value="Sulfuric Acid 50%">Sulfuric Acid 50%</option>
                                <option value="Sulfuric Acid 66BE">Sulfuric Acid 66BE</option>
                                <option value="Sulfuric Acid 93%">Sulfuric Acid 93%</option>
                                <option value="Sulfuric Acid 99%">Sulfuric Acid 99%</option>
                                <option value="Sumaclear">Sumaclear (various types)</option>
                                <option value="Sumaclear 50">Sumaclear 50</option>
                                <option value="Sumaclear 700">Sumaclear 700</option>
                                <option value="Sumaclear 750">Sumaclear 750</option>
                                <option value="Sumaclear 1000">Sumaclear 1000</option>
                                <option value="Sumaclear P20">Sumaclear P20</option>
                                <option value="Sumaclear P30">Sumaclear P30</option>
                                <option value="Superfloc C1600">Superfloc C1600</option>
                                <option value="SVENFLOC C4640">SVENFLOC C4640</option>
                                <option value="SWT 8809">SWT 8809</option>
                                <option value="T-Floc">T-Floc (various types)</option>
                                <option value="T-Floc 1416">T-Floc 1416</option>
                                <option value="T-Floc 1419">T-Floc 1419</option>
                                <option value="T-Floc 1465">T-Floc 1465</option>
                                <option value="T-Floc B-41">T-Floc B-41</option>
                                <option value="T-Floc B-135">T-Floc B-135</option>
                                <option value="T-Floc PN3100">T-Floc PN3100</option>
                                <option value="Torch LT">Torch LT</option>
                                <option value="Torch Z">Torch Z</option>
                                <option value="TriChlor Tablets">TriChlor 3" Tablets</option>
                                <option value="Trioxyn">Trioxyn</option>
                                <option value="Ultrion 8157">Ultrion 8157</option>
                                <option value="Ultrion 8185">Ultrion 8185</option>
                                <option value="Ultrion 8187">Ultrion 8187</option>
                                <option value="Urea">Urea</option>
                                <option value="Vita-D-Chlor">Vita-D-Chlor</option>
                                <option value="WPH 1000">WPH 1000</option>
                                <option value="Zetag 7557">Zetag 7557</option>
                                <option value="Zetag 7878">Zetag 7878</option>
                                <option value="Zetag 8846">Zetag 8846</option>
                                <option value="Zetag 8848">Zetag 8848</option>
                                <option value="Zetag 8849">Zetag 8849</option>
                                <option value="Zetag 8858">Zetag 8858</option>
                                <option value="Zetag 8868">Zetag 8868</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timeline">Delivery Timeline:</label>
                            <select id="timeline" required>
                                <option value="">Select timeline...</option>
                                <option value="ASAP">ASAP (Rush)</option>
                                <option value="1 week">Within 1 week</option>
                                <option value="2 weeks">Within 2 weeks</option>
                                <option value="1 month">Within 1 month</option>
                                <option value="Flexible">Flexible</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customerType">Customer Type:</label>
                        <select id="customerType" required>
                            <option value="">Select type...</option>
                            <option value="Municipal">Municipal/Government</option>
                            <option value="Industrial">Industrial</option>
                            <option value="Commercial">Commercial</option>
                            <option value="Residential">Residential</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="specialRequirements">Special Requirements:</label>
                        <textarea id="specialRequirements" rows="3" placeholder="Any special delivery, quality, or service requirements..."></textarea>
                    </div>

                    <button class="btn btn-secondary" type="button" onclick="loadCompetitorData()">
                        ðŸ“Š Load Competitor Data
                    </button>
                    <div id="dataStatus"></div>

                    <button type="submit" class="btn" id="calculateBtn">
                        ðŸŽ¯ Get AI Pricing Recommendation
                    </button>
                </form>
            </div>

            <div class="results-section">
                <h2 class="section-title">Pricing Analysis</h2>
                
                <div id="loading" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Analyzing competitor data and generating intelligent pricing...</p>
                </div>

                <div id="results" class="results">
                    <div class="price-result">
                        <div class="price-amount" id="recommendedPrice">$4.25/gallon</div>
                        <div class="margin-display" id="marginDisplay">40% Gross Profit</div>
                    </div>

                    <div class="reasoning">
                        <h3>ðŸ§  AI Analysis & Reasoning</h3>
                        <div id="pricingReasoning">
                            <p>Detailed analysis will appear here...</p>
                        </div>
                    </div>

                    <div class="recommendations" id="recommendationsSection" style="display: none;">
                        <h3>ðŸ’¡ Strategic Recommendations</h3>
                        <div id="strategicRecommendations"></div>
                    </div>

                    <!-- Feedback Section -->
                    <div class="feedback-section">
                        <h3>ðŸ’¬ Follow-up or Correction</h3>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">Have feedback or want to adjust the recommendation?</p>
                        <textarea id="feedbackInput" class="feedback-input" rows="3" placeholder="e.g., 'This seems too high, can you recalculate with a lower margin?' or 'Did you consider that this is a rush order?'"></textarea>
                        <button class="btn btn-feedback" id="submitFeedback">
                            ðŸ”„ Re-analyze with Feedback
                        </button>
                    </div>

                    <!-- Conversation History -->
                    <div class="conversation-history" id="conversationHistory" style="display: none;">
                        <h4 style="margin-bottom: 10px; font-size: 1rem;">Conversation History:</h4>
                        <div id="conversationMessages"></div>
                    </div>
                </div>

                <div id="competitorPreview" class="competitor-preview" style="display: none;">
                    <h4>ðŸ“Š Relevant Competitor Data</h4>
                    <div id="competitorData"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let competitorData = [];
        let isLoading = false;
        let conversationHistory = [];
        let currentCustomerDetails = null;
        let currentRelevantData = null;

        // Load competitor data from Google Sheets via Netlify Function
        async function loadCompetitorData() {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.innerHTML = '<div class="data-status">Loading competitor data...</div>';

            try {
                const response = await fetch('/.netlify/functions/get-sheets-data', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to load data: ${errorText}`);
                }

                const result = await response.json();
                competitorData = result.data;

                statusDiv.innerHTML = `
                    <div class="data-status">
                        âœ… Loaded ${competitorData.length} competitor records<br>
                        Last updated: ${new Date().toLocaleTimeString()}
                    </div>
                `;

                console.log('Loaded competitor data:', competitorData.slice(0, 3));
            } catch (error) {
                console.error('Error loading data:', error);
                statusDiv.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
            }
        }

        // Filter competitor data based on customer details
        function filterRelevantData(customerDetails) {
            if (!competitorData.length) return [];

            const filtered = competitorData.filter(row => {
                // Location match
                const locationMatch = 
                    (row.County && row.County.toLowerCase().includes(customerDetails.location.toLowerCase())) ||
                    (row.District && row.District.toLowerCase().includes(customerDetails.location.toLowerCase())) ||
                    (row['Water system served'] && row['Water system served'].toLowerCase().includes(customerDetails.location.toLowerCase()));

                // Product match (handle variations)
                let productMatch = true;
                if (customerDetails.product && customerDetails.product !== 'Other') {
                    const searchTerms = customerDetails.product.toLowerCase().split(/[\s-]+/);
                    productMatch = row['Product purchased'] && 
                                  searchTerms.some(term => row['Product purchased'].toLowerCase().includes(term));
                }

                // REQUIRE BOTH location AND product to match
                return locationMatch && productMatch;
            });

            console.log(`Found ${filtered.length} matching rows for ${customerDetails.location}`);
            return filtered.slice(0, 20);
        }

        // Submit feedback and re-analyze
        document.getElementById('submitFeedback').addEventListener('click', async function() {
            const feedbackText = document.getElementById('feedbackInput').value.trim();
            
            if (!feedbackText) {
                alert('Please enter your feedback or question');
                return;
            }

            if (!currentCustomerDetails || !currentRelevantData) {
                alert('Please run an initial analysis first');
                return;
            }

            // Add user feedback to conversation history
            conversationHistory.push({
                role: 'user',
                content: feedbackText
            });

            // Clear feedback input
            document.getElementById('feedbackInput').value = '';

            // Show loading
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';

            try {
                // Call Claude API with conversation history
                const response = await fetch('/.netlify/functions/get-claude-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customerDetails: currentCustomerDetails,
                        relevantData: currentRelevantData,
                        conversationHistory: conversationHistory
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Claude API error: ${errorText}`);
                }

                const result = await response.json();

                // Add assistant response to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: result.reasoning
                });

                // Update UI with new results
                document.getElementById('recommendedPrice').textContent = result.price || 'See analysis below';
                document.getElementById('marginDisplay').textContent = result.margin || '';
                document.getElementById('pricingReasoning').innerHTML = 
                    result.reasoning.split('\n').map(line => `<p>${line}</p>`).join('');

                if (result.recommendations) {
                    document.getElementById('strategicRecommendations').innerHTML = 
                        result.recommendations.split('\n').map(line => `<p>${line}</p>`).join('');
                    document.getElementById('recommendationsSection').style.display = 'block';
                }

                // Update conversation history display
                updateConversationDisplay();

                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                loadingDiv.style.display = 'none';
                alert(`Error re-analyzing: ${error.message}`);
            }
        });

        // Update conversation history display
        function updateConversationDisplay() {
            const historyDiv = document.getElementById('conversationHistory');
            const messagesDiv = document.getElementById('conversationMessages');
            
            if (conversationHistory.length > 0) {
                historyDiv.style.display = 'block';
                messagesDiv.innerHTML = conversationHistory.map(msg => 
                    `<div class="conversation-message ${msg.role}-message">
                        <strong>${msg.role === 'user' ? 'Your Feedback' : 'Claude'}:</strong><br>
                        ${msg.content.substring(0, 150)}${msg.content.length > 150 ? '...' : ''}
                    </div>`
                ).join('');
            }
        }
        
        // Handle form submission
        document.getElementById('pricingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            if (!competitorData.length) {
                alert('Please load competitor data first');
                return;
            }

            isLoading = true;
            const calculateBtn = document.getElementById('calculateBtn');
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const competitorPreview = document.getElementById('competitorPreview');

            calculateBtn.disabled = true;
            calculateBtn.textContent = 'Analyzing...';
            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            competitorPreview.style.display = 'none';

            // Reset conversation for new request
            conversationHistory = [];
            document.getElementById('conversationHistory').style.display = 'none';

            try {
                const customerDetails = {
                    location: document.getElementById('location').value.trim(), // Auto-trim spaces
                    volume: document.getElementById('volume').value.trim(),
                    product: document.getElementById('product').value,
                    timeline: document.getElementById('timeline').value,
                    customerType: document.getElementById('customerType').value,
                    specialRequirements: document.getElementById('specialRequirements').value.trim()
                };

                // Store for feedback functionality
                currentCustomerDetails = customerDetails;

                const relevantData = filterRelevantData(customerDetails);
                
                if (relevantData.length === 0) {
                    throw new Error('No relevant competitor data found for this location/product. Claude will use neighboring counties.');
                }

                // Store for feedback functionality
                currentRelevantData = relevantData;

                // Show competitor data preview
                const competitorDataDiv = document.getElementById('competitorData');
                competitorDataDiv.innerHTML = relevantData.slice(0, 5).map(row => 
                    `<div class="competitor-row">
                        ${row.Supplier || 'Unknown'} - ${row['Product purchased'] || 'N/A'} - 
                        $${row['Price per Gal/Lbs'] || 'N/A'} - ${row.County || row.District || 'Unknown location'}
                    </div>`
                ).join('');
                competitorPreview.style.display = 'block';

                // Call Claude API via Netlify Function
                const response = await fetch('/.netlify/functions/get-claude-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customerDetails,
                        relevantData,
                        conversationHistory: []
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Claude API error: ${errorText}`);
                }

                const result = await response.json();
                
                document.getElementById('recommendedPrice').textContent = result.price || 'See analysis below';
                document.getElementById('marginDisplay').textContent = result.margin || '';
                document.getElementById('pricingReasoning').innerHTML = 
                    result.reasoning.split('\n').map(line => `<p>${line}</p>`).join('');

                if (result.recommendations) {
                    document.getElementById('strategicRecommendations').innerHTML = 
                        result.recommendations.split('\n').map(line => `<p>${line}</p>`).join('');
                    document.getElementById('recommendationsSection').style.display = 'block';
                } else {
                    document.getElementById('recommendationsSection').style.display = 'none';
                }

                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                loadingDiv.style.display = 'none';
                alert(`Error generating pricing: ${error.message}`);
            } finally {
                isLoading = false;
                calculateBtn.disabled = false;
                calculateBtn.textContent = 'ðŸŽ¯ Get AI Pricing Recommendation';
            }
        });

        // Auto-load on page ready
        document.addEventListener('DOMContentLoaded', function() {
            loadCompetitorData();
        });
    </script>
</body>
</html>
